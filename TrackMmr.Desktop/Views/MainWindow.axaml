<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:TrackMmr.Desktop.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
        xmlns:asyncImageLoader="clr-namespace:AsyncImageLoader;assembly=AsyncImageLoader.Avalonia"
        mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="800"
        x:Class="TrackMmr.Desktop.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Dota 2 MMR Tracker"
        Width="900" Height="800"
        Background="Transparent"
        TransparencyLevelHint="AcrylicBlur"
        ExtendClientAreaToDecorationsHint="True">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Window.Styles>
        <Style Selector="Border.Card">
            <Setter Property="Background" Value="#CC252525"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="BoxShadow" Value="0 8 24 0 #30000000"/>
        </Style>
    </Window.Styles>

    <Panel>
        <!-- Background Acrylic Layer -->
        <ExperimentalAcrylicBorder IsHitTestVisible="False">
            <ExperimentalAcrylicBorder.Material>
                <ExperimentalAcrylicMaterial
                    BackgroundSource="Digger"
                    TintColor="Black"
                    TintOpacity="0.9"
                    MaterialOpacity="0.8" />
            </ExperimentalAcrylicBorder.Material>
        </ExperimentalAcrylicBorder>

        <Grid RowDefinitions="Auto, *">
            <!-- Custom Title Bar Area (for drag) -->
            <Border Grid.Row="0" Height="50" Background="Transparent" IsHitTestVisible="False">
                <Grid ColumnDefinitions="*, Auto" Margin="20,15,20,0">
                    <TextBlock Text="TRACK MMR" FontSize="14" FontWeight="Black" Foreground="DodgerBlue" LetterSpacing="2"/>
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10">
                        <Ellipse Width="8" Height="8" Fill="#4CAF50" VerticalAlignment="Center"/>
                        <TextBlock Text="Connected" FontSize="11" Foreground="#888" VerticalAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </Border>

            <ScrollViewer Grid.Row="1">
                <StackPanel Margin="30,10,30,40" Spacing="25">
                    
                    <!-- Top Summary Card -->
                    <Grid ColumnDefinitions="*, Auto">
                        <StackPanel Spacing="5">
                            <TextBlock Text="Current MMR" FontSize="14" Foreground="#777"/>
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBlock Text="{Binding CurrentMmr}" FontSize="56" FontWeight="Black" Foreground="White"/>
                                <TextBlock Text="MMR" FontSize="18" FontWeight="Bold" Foreground="DodgerBlue" VerticalAlignment="Bottom" Margin="0,0,0,10"/>
                            </StackPanel>
                        </StackPanel>
                        
                        <Button Grid.Column="1" Command="{Binding FetchMmrCommand}" IsEnabled="{Binding !IsBusy}" 
                                VerticalAlignment="Bottom" Margin="0,0,0,10"
                                Padding="15,8" Background="#20FFFFFF" CornerRadius="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <PathIcon Data="M12 2V5M12 19V22M4.22 4.22L6.34 6.34M17.66 17.66L19.78 19.78M2 12H5M19 12H22M4.22 19.78L6.34 17.66M17.66 6.34L19.78 4.22" Width="14"/>
                                <TextBlock Text="Sync Data" FontWeight="Bold"/>
                            </StackPanel>
                        </Button>
                    </Grid>

                    <!-- Chart Card -->
                    <Border Classes="Card">
                        <StackPanel Spacing="15">
                            <TextBlock Text="Performance Trend" FontSize="16" FontWeight="Bold" Foreground="#BBBBBB"/>
                            <lvc:CartesianChart Height="280" Series="{Binding MmrSeries}" XAxes="{Binding XAxes}" YAxes="{Binding YAxes}" />
                        </StackPanel>
                    </Border>

                    <!-- History Section -->
                    <StackPanel Spacing="15">
                        <TextBlock Text="Recent Match History" FontSize="16" FontWeight="Bold" Foreground="#BBBBBB" Margin="5,0"/>
                        <ItemsControl ItemsSource="{Binding Matches}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:MatchRowViewModel">
                                    <Border Classes="Card" Margin="0,0,0,10" Padding="15">
                                        <Grid ColumnDefinitions="Auto, *, Auto, Auto, 100">
                                            <Border Grid.Column="0" CornerRadius="4" ClipToBounds="True" Margin="0,0,20,0">
                                                <Image asyncImageLoader:ImageLoader.Source="{Binding HeroIconUrl}" Width="60" Height="34" Stretch="UniformToFill"/>
                                            </Border>
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Hero}" FontSize="16" FontWeight="Bold"/>
                                                <TextBlock Text="{Binding Date}" FontSize="12" Foreground="#666"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="2" VerticalAlignment="Center" Margin="0,0,30,0" HorizontalAlignment="Right">
                                                <TextBlock Text="{Binding Mmr}" FontSize="18" FontWeight="Black" HorizontalAlignment="Right"/>
                                                <TextBlock Text="MMR" FontSize="9" FontWeight="Bold" Foreground="#444" HorizontalAlignment="Right"/>
                                            </StackPanel>
                                            <TextBlock Grid.Column="3" Text="{Binding MmrChange}" Foreground="{Binding ResultBrush}" FontSize="18" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,30,0"/>
                                            <Border Grid.Column="4" Background="{Binding ResultBrush}" CornerRadius="20" Padding="12,4" HorizontalAlignment="Stretch">
                                                <TextBlock Text="{Binding Result}" HorizontalAlignment="Center" FontWeight="Black" FontSize="12" Foreground="White"/>
                                            </Border>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
        </Grid>

        <!-- Overlays (Login & Loading) -->
        <Border IsVisible="{Binding NeedsLogin}" Background="#EE000000" ZIndex="100">
            <Border Classes="Card" Width="380" Padding="35" VerticalAlignment="Center">
                <StackPanel Spacing="20">
                    <TextBlock Text="Steam Login" FontSize="22" FontWeight="Black" HorizontalAlignment="Center"/>
                    <TextBox Text="{Binding Username}" Watermark="Username" Height="45"/>
                    <TextBox Text="{Binding Password}" Watermark="Password" PasswordChar="â—" Height="45"/>
                    <Button Command="{Binding LoginAndFetchCommand}" Content="Login" HorizontalAlignment="Stretch" Height="45" Background="#1A73E8" Foreground="White"/>
                    <TextBlock Text="{Binding StatusText}" Foreground="#F44336" FontSize="12" HorizontalAlignment="Center" TextWrapping="Wrap"/>
                </StackPanel>
            </Border>
        </Border>

        <Border IsVisible="{Binding IsBusy}" Background="#AA000000" ZIndex="50">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="20">
                <ProgressBar IsIndeterminate="True" Width="200" Foreground="DodgerBlue"/>
                <TextBlock Text="{Binding StatusText}" FontWeight="Bold"/>
            </StackPanel>
        </Border>
    </Panel>
</Window>
